<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp Sticker Maker Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..800;1,9..40,300..800&family=JetBrains+Mono:wght@400;600&family=Pacifico&family=Oswald:wght@400;700&family=Bebas+Neue&family=Permanent+Marker&family=Bangers&family=Fredoka:wght@400;600;700&family=Righteous&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06090f;--surface:#0c1118;--surface2:#111821;--surface3:#18202e;
  --text:#e8edf6;--text2:#8a97b0;--text3:#58657d;
  --accent:#25d366;--accent2:#128c7e;
  --orange:#ff9500;--red:#ff3b5c;
  --border:rgba(255,255,255,.06);--border2:rgba(255,255,255,.11);
  --r:16px;--rs:10px;
  --font:'DM Sans',system-ui,sans-serif;
  --mono:'JetBrains Mono',ui-monospace,monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);color:var(--text);background:var(--bg);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(800px 500px at 20% -5%,rgba(37,211,102,.1),transparent),radial-gradient(600px 400px at 85% 10%,rgba(18,140,126,.08),transparent);pointer-events:none;z-index:0}
.app{position:relative;z-index:1;max-width:1220px;margin:0 auto;padding:16px 20px 40px}
.header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:16px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px rgba(37,211,102,.3)}
.logo-text h1{font-size:17px;font-weight:700;letter-spacing:-.3px}
.logo-text p{font-size:11px;color:var(--text2);font-weight:500}
.hbadges{display:flex;gap:6px;flex-wrap:wrap}
.hb{font-size:10px;font-weight:600;padding:5px 10px;border-radius:999px;border:1px solid var(--border);background:var(--surface);color:var(--text2);display:flex;align-items:center;gap:5px}
.hb .d{width:5px;height:5px;border-radius:50%;background:var(--accent)}
.hb.anim .d{background:var(--orange);animation:pd 1.5s infinite}
@keyframes pd{0%,100%{opacity:1}50%{opacity:.3}}
.tabs{display:flex;gap:3px;padding:3px;background:var(--surface);border:1px solid var(--border);border-radius:13px;margin-bottom:14px;width:fit-content}
.tab{padding:9px 18px;border-radius:10px;border:none;background:0;color:var(--text2);font-family:var(--font);font-size:12.5px;font-weight:600;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:7px}
.tab:hover{color:var(--text);background:rgba(255,255,255,.04)}
.tab.active{background:linear-gradient(135deg,rgba(37,211,102,.15),rgba(18,140,126,.12));color:var(--accent);box-shadow:0 2px 10px rgba(37,211,102,.12)}
.mg{display:grid;grid-template-columns:1fr 370px;gap:14px}
@media(max-width:1040px){.mg{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.ci{padding:16px}
.ct{font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:7px;text-transform:uppercase;letter-spacing:.7px}
.ct .n{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center}
.dz{border:2px dashed rgba(255,255,255,.1);border-radius:13px;padding:24px 16px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;min-height:160px;cursor:pointer;transition:.25s;background:rgba(0,0,0,.12);text-align:center}
.dz:hover{border-color:rgba(37,211,102,.35);background:rgba(37,211,102,.03)}
.dz.dragover{border-color:var(--accent);background:rgba(37,211,102,.07)}
.dz-i{font-size:32px;opacity:.6}
.dz-t{font-size:13px;font-weight:650}
.dz-h{font-size:11px;color:var(--text2);line-height:1.45;max-width:400px}
.dz-a{display:flex;gap:7px;margin-top:3px}
input[type=file]{display:none}
.btn{border:1px solid var(--border2);background:var(--surface2);color:var(--text);padding:9px 14px;border-radius:var(--rs);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:7px;white-space:nowrap}
.btn:hover:not(:disabled){transform:translateY(-1px);border-color:rgba(255,255,255,.18);box-shadow:0 4px 14px rgba(0,0,0,.3)}
.btn:active:not(:disabled){transform:translateY(0)}
.btn:disabled{opacity:.35;cursor:not-allowed}
.btn.pri{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;box-shadow:0 3px 16px rgba(37,211,102,.22)}
.btn.pri:hover:not(:disabled){box-shadow:0 5px 24px rgba(37,211,102,.32)}
.btn.dan{border-color:rgba(255,59,92,.25);color:var(--red)}
.btn-s{padding:6px 10px;font-size:11px;border-radius:7px}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:640px){.pg{grid-template-columns:1fr}}
.pp{background:var(--surface2);border:1px solid var(--border);border-radius:13px;overflow:hidden}
.ph{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-bottom:1px solid var(--border);font-size:10px;color:var(--text2)}
.ph strong{color:var(--text);font-size:11px}
.pb{padding:8px}
/* Checker pattern for transparency visualization */
.ck{
  width:100%;aspect-ratio:1;border-radius:10px;overflow:hidden;
  border:1px solid var(--border);position:relative;
  background-color:#1a1a2e;
  background-image:
    linear-gradient(45deg,#252540 25%,transparent 25%,transparent 75%,#252540 75%),
    linear-gradient(45deg,#252540 25%,transparent 25%,transparent 75%,#252540 75%);
  background-size:20px 20px;
  background-position:0 0,10px 10px;
}
.ck img,.ck canvas,.ck video{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:contain;display:block;background:transparent !important;
}
.ck .plh{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  color:var(--text3);font-size:11px;font-weight:500;background:rgba(0,0,0,.3);
}
.ar{display:flex;gap:7px;flex-wrap:wrap;margin-top:12px}
.prg{width:100%;height:3px;border-radius:2px;background:var(--surface3);overflow:hidden;display:none;margin-top:6px}
.prg.on{display:block}
.prg .f{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s}
.controls{display:grid;gap:8px}
.fld{padding:12px;border:1px solid var(--border);border-radius:12px;background:rgba(0,0,0,.1)}
.fl{display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px}
.fl strong{color:var(--text);font-weight:650}
.fl .v{font-family:var(--mono);font-size:10px;color:var(--accent)}
.fh{font-size:10px;color:var(--text3);line-height:1.4;margin-top:4px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:640px){.fr{grid-template-columns:1fr}}
input[type=range]{width:100%;height:5px;-webkit-appearance:none;appearance:none;background:var(--surface3);border-radius:3px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 2px 6px rgba(37,211,102,.35)}
select,input[type=text],input[type=number]{width:100%;padding:8px 10px;border-radius:9px;border:1px solid var(--border2);background:var(--surface3);color:var(--text);font-family:var(--font);font-size:12px;outline:none}
select:focus,input[type=text]:focus{border-color:var(--accent)}
input[type=color]{width:100%;height:32px;padding:2px;border-radius:9px;border:1px solid var(--border2);background:var(--surface3);cursor:pointer}
.sw{position:relative;width:36px;height:20px;display:inline-block}
.sw input{opacity:0;width:0;height:0}
.sw .sl{position:absolute;inset:0;border-radius:10px;background:var(--surface3);transition:.2s;cursor:pointer}
.sw .sl::before{content:'';position:absolute;width:14px;height:14px;border-radius:50%;background:var(--text2);left:3px;bottom:3px;transition:.2s}
.sw input:checked+.sl{background:var(--accent)}
.sw input:checked+.sl::before{transform:translateX(16px);background:#fff}
.tr{display:flex;align-items:center;justify-content:space-between;gap:8px}
.tr label{font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;cursor:pointer}
.sp{padding:12px;border:1px solid var(--border);border-radius:12px;background:rgba(0,0,0,.1);display:grid;gap:6px}
.sln{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text2)}
.sln strong{color:var(--text);font-family:var(--mono);font-size:10px}
.pill{font-size:9px;font-weight:700;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-family:var(--mono);text-transform:uppercase}
.pill.ok{border-color:rgba(37,211,102,.25);background:rgba(37,211,102,.08);color:#6ee7a0}
.pill.warn{border-color:rgba(255,149,0,.25);background:rgba(255,149,0,.08);color:#ffb84d}
.plr{display:flex;gap:5px;flex-wrap:wrap}
.ib{font-size:10.5px;color:var(--text2);line-height:1.45;padding:10px;border-radius:10px;background:rgba(37,211,102,.03);border:1px solid rgba(37,211,102,.08)}
.ib strong{color:var(--text)}
.sec-s,.sec-a{display:none}
.sec-s.vis,.sec-a.vis{display:block}
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:none}
.spinner.on{display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.txt-list{display:grid;gap:6px;margin-bottom:8px;max-height:320px;overflow-y:auto}
.txt-item{padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(0,0,0,.1);display:grid;gap:6px;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.txt-item .ti-head{display:flex;align-items:center;justify-content:space-between}
.txt-item .ti-head span{font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.5px}
.txt-item .ti-remove{width:22px;height:22px;border-radius:6px;border:1px solid rgba(255,59,92,.2);background:rgba(255,59,92,.08);color:var(--red);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.txt-item .ti-remove:hover{background:rgba(255,59,92,.2)}
.txt-item input[type=text]{font-size:12px;padding:7px 9px}
.txt-item .ti-row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.txt-item .ti-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.txt-item select{font-size:11px;padding:6px 8px}
.txt-item input[type=range]{height:4px}
.txt-item input[type=color]{height:28px}
.ti-label{font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:2px}
.ti-style-btns{display:flex;gap:4px}
.ti-style-btns button{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:var(--surface3);color:var(--text2);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ti-style-btns button.active{border-color:var(--accent);background:rgba(37,211,102,.12);color:var(--accent)}
.ti-pos{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.ti-pos>.ti-label{grid-column:1/-1}
</style>
</head>
<body>
<div class="app">
<header class="header">
  <div class="logo"><div class="logo-icon">ğŸ’¬</div><div class="logo-text"><h1>WhatsApp Sticker Maker Pro</h1><p>Static &amp; Animated Â· Text overlays Â· Transparent backgrounds</p></div></div>
  <div class="hbadges"><div class="hb"><span class="d"></span>Static 512Ã—512</div><div class="hb anim"><span class="d"></span>Animated 512Ã—512</div></div>
</header>

<div class="tabs">
  <button class="tab active" data-tab="static"><span>ğŸ–¼ï¸</span> Static Sticker</button>
  <button class="tab" data-tab="animated"><span>ğŸï¸</span> Animated Sticker</button>
</div>

<div class="mg">
<div class="left-col">

<!-- STATIC -->
<div class="sec-s vis" id="secStatic"><div class="card"><div class="ci">
  <div class="ct"><span class="n">1</span>Upload Image</div>
  <input id="sFileIn" type="file" accept="image/png,image/jpeg,image/gif,image/webp"/>
  <div id="sDz" class="dz" tabindex="0">
    <div class="dz-i">ğŸ“</div>
    <div class="dz-t">Drop an image here or click to browse</div>
    <div class="dz-h">PNG (with transparency), JPG, GIF or WEBP</div>
    <div class="dz-a"><button class="btn btn-s pri" id="sBrw">Browse files</button><button class="btn btn-s dan" id="sClr" disabled>Clear</button></div>
  </div>
  <div style="height:12px"></div>
  <div class="ct"><span class="n">2</span>Preview</div>
  <div class="pg">
    <div class="pp"><div class="ph"><strong>Original</strong><span id="sOM">â€”</span></div><div class="pb"><div class="ck"><img id="sOI" alt="" style="display:none"/><span class="plh" id="sOP">No image</span></div></div></div>
    <div class="pp"><div class="ph"><strong>Sticker Output</strong><span id="sXM">â€”</span></div><div class="pb"><div class="ck"><canvas id="sOC" width="512" height="512"></canvas></div></div></div>
  </div>
  <div class="prg" id="sPrg"><div class="f" id="sPF"></div></div>
  <div class="ar">
    <button class="btn pri" id="sGen" disabled><span class="spinner" id="sSp"></span>Generate Sticker</button>
    <button class="btn" id="sShr" disabled>ğŸ“² Share to WhatsApp</button>
    <button class="btn" id="sDl" disabled>â¬‡ Download .WEBP</button>
  </div>
</div></div></div>

<!-- ANIMATED -->
<div class="sec-a" id="secAnim"><div class="card"><div class="ci">
  <div class="ct"><span class="n">1</span>Upload GIF or Video</div>
  <input id="aFileIn" type="file" accept="image/gif,video/mp4,video/webm"/>
  <div id="aDz" class="dz" tabindex="0">
    <div class="dz-i">ğŸ¬</div>
    <div class="dz-t">Drop a GIF or short video here</div>
    <div class="dz-h">GIF, MP4 or WEBM Â· Max 8s Â· 512Ã—512 â‰¤500KB</div>
    <div class="dz-a"><button class="btn btn-s pri" id="aBrw">Browse files</button><button class="btn btn-s dan" id="aClr" disabled>Clear</button></div>
  </div>
  <div style="height:12px"></div>
  <div class="ct"><span class="n">2</span>Preview</div>
  <div class="pg">
    <div class="pp"><div class="ph"><strong>Original</strong><span id="aOM">â€”</span></div><div class="pb"><div class="ck"><img id="aOI" alt="" style="display:none"/><video id="aOV" muted loop playsinline style="display:none"></video><span class="plh" id="aOP">No file</span></div></div></div>
    <div class="pp"><div class="ph"><strong>Animated Sticker</strong><span id="aXM">â€”</span></div><div class="pb"><div class="ck"><canvas id="aOC" width="512" height="512"></canvas><img id="aXI" alt="" style="display:none"/></div></div></div>
  </div>
  <div class="prg" id="aPrg"><div class="f" id="aPF"></div></div>
  <div class="ar">
    <button class="btn pri" id="aGen" disabled><span class="spinner" id="aSp"></span>Generate Animated Sticker</button>
    <button class="btn" id="aShr" disabled>ğŸ“² Share to WhatsApp</button>
    <button class="btn" id="aDl" disabled>â¬‡ Download .WEBP</button>
  </div>
  <div class="ib" style="margin-top:10px"><strong>Animated stickers:</strong> Frames extracted &amp; processed at 512Ã—512 with full alpha transparency. Original GIF timing preserved.</div>
</div></div></div>

</div><!-- left -->

<!-- RIGHT COLUMN -->
<aside class="right-col"><div class="card"><div class="ci">
  <div class="ct">âš™ï¸ Sticker Settings</div>
  <div class="controls">
    <div class="fr">
      <div class="fld"><div class="fl"><strong>Padding</strong><span class="v" id="lP">24px</span></div><input id="cPad" type="range" min="0" max="100" value="24"/></div>
      <div class="fld"><div class="fl"><strong>Auto-Trim</strong></div><div class="tr"><label>Trim transparent edges</label><label class="sw"><input id="cTrim" type="checkbox" checked/><span class="sl"></span></label></div><div class="fh">Removes empty borders on PNGs.</div></div>
    </div>
    <div class="fr">
      <div class="fld"><div class="fl"><strong>Background</strong></div>
        <select id="cBg"><option value="transparent" selected>Transparent</option><option value="solid">Solid color</option></select>
        <input id="cBgC" type="color" value="#000000" style="margin-top:5px" disabled/>
      </div>
      <div class="fld"><div class="fl"><strong>Max Size</strong><span class="v" id="lMK">100KB</span></div><input id="cMK" type="range" min="30" max="500" value="100"/><div class="fh sec-s vis">Static â‰¤100KB</div><div class="fh sec-a">Animated â‰¤500KB</div></div>
    </div>
    <div class="fr">
      <div class="fld"><div class="fl"><strong>Outline</strong><span class="v" id="lOW">10px</span></div><input id="cOW" type="range" min="0" max="24" value="10"/><input id="cOC" type="color" value="#ffffff" style="margin-top:5px"/></div>
      <div class="fld"><div class="fl"><strong>Shadow</strong><span class="v" id="lSB">6px</span></div><input id="cSB" type="range" min="0" max="24" value="6"/><input id="cSC" type="color" value="#000000" style="margin-top:5px"/></div>
    </div>

    <!-- Animated-only -->
    <div class="sec-a" id="animS">
      <div class="fld"><div class="fl"><strong>Max Duration</strong><span class="v" id="lDur">8s</span></div><input id="cDur" type="range" min="1" max="8" value="8"/><div class="fh">WhatsApp max: 8s.</div></div>
      <div class="fld" style="margin-top:8px"><div class="fl"><strong>Speed</strong><span class="v" id="lSpd">1.0Ã—</span></div><input id="cSpd" type="range" min="25" max="300" value="100"/><div class="fh">1.0Ã— = original speed.</div></div>
      <div class="fld" style="margin-top:8px"><div class="fl"><strong>Quality</strong><span class="v" id="lQ">70%</span></div><input id="cQ" type="range" min="10" max="95" value="70"/><div class="fh">Lower = smaller file.</div></div>
    </div>

    <!-- Text overlays -->
    <div class="fld">
      <div class="fl"><strong>ğŸ“ Text Overlays</strong><span class="v" id="lTC">0</span></div>
      <div class="txt-list" id="txtL"></div>
      <button class="btn btn-s" id="txtA" style="width:100%;justify-content:center">+ Add Text</button>
    </div>

    <!-- Status -->
    <div class="sp">
      <div class="sln"><span>Input</span><strong id="stIn">No file</strong></div>
      <div class="sln"><span>Output</span><strong id="stOut">â€”</strong></div>
      <div class="sln"><span>Compliance</span><strong id="stCo">â€”</strong></div>
      <div class="plr"><span class="pill" id="plD">512Ã—512</span><span class="pill" id="plS">â€”</span><span class="pill" id="plT">â€”</span></div>
    </div>
    <div class="ib"><strong>ğŸ“² Share to WhatsApp</strong> uses your device's share sheet on mobile. On desktop, the file downloads â€” then attach in WhatsApp and use "Create sticker".</div>
  </div>
</div></div></aside>

</div><!-- mg -->
</div><!-- app -->

<script>
(function(){
'use strict';

/* â”€â”€ Helpers â”€â”€ */
var $=function(id){return document.getElementById(id)};
var clamp=function(v,a,b){return Math.min(b,Math.max(a,v))};
var fmtB=function(b){if(!Number.isFinite(b))return'â€”';var k=b/1024;return k<1024?k.toFixed(1)+'KB':(k/1024).toFixed(2)+'MB'};
function c2b(c,t,q){return new Promise(function(r){c.toBlob(function(b){r(b)},t,q)})}

/* â”€â”€ Tabs â”€â”€ */
var tabs=document.querySelectorAll('.tab');
var secS=document.querySelectorAll('.sec-s');
var secA=document.querySelectorAll('.sec-a');
var mode='static';
tabs.forEach(function(t){t.addEventListener('click',function(){
  tabs.forEach(function(x){x.classList.remove('active')});t.classList.add('active');
  mode=t.dataset.tab;
  secS.forEach(function(s){s.classList.toggle('vis',mode==='static')});
  secA.forEach(function(s){s.classList.toggle('vis',mode==='animated')});
  if(mode==='animated'&&parseInt(cMK.value)<200){cMK.value=500;uL()}
  if(mode==='static'&&parseInt(cMK.value)>300){cMK.value=100;uL()}
})});

/* â”€â”€ Controls â”€â”€ */
var cPad=$('cPad'),cTrim=$('cTrim'),cBg=$('cBg'),cBgC=$('cBgC'),cMK=$('cMK');
var cOW=$('cOW'),cOC=$('cOC'),cSB=$('cSB'),cSC=$('cSC');
var cDur=$('cDur'),cSpd=$('cSpd'),cQ=$('cQ');

function uL(){
  $('lP').textContent=cPad.value+'px';
  $('lMK').textContent=cMK.value+'KB';
  $('lOW').textContent=cOW.value+'px';
  $('lSB').textContent=cSB.value+'px';
  $('lDur').textContent=cDur.value+'s';
  $('lSpd').textContent=(parseInt(cSpd.value)/100).toFixed(1)+'Ã—';
  $('lQ').textContent=cQ.value+'%';
  cBgC.disabled=(cBg.value!=='solid');
}
[cPad,cTrim,cBg,cBgC,cMK,cOW,cOC,cSB,cSC,cDur,cSpd,cQ].forEach(function(el){
  el.addEventListener('input',function(){uL();if(mode==='static'&&sImg)renderSP()})
});
uL();

function setPl(el,t){el.classList.remove('ok','warn');if(t)el.classList.add(t)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEXT OVERLAYS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var FONTS=['DM Sans','Pacifico','Oswald','Bebas Neue','Permanent Marker','Bangers','Fredoka','Righteous','Impact','Georgia','Courier New'];
var txts=[];
var txId=0;

$('txtA').addEventListener('click',function(){
  txts.push({id:++txId,text:'Sticker',font:'Bangers',size:60,color:'#ffffff',sc:'#000000',sw:3,bold:false,italic:false,x:256,y:440,rot:0});
  renderTxtList();
  if(mode==='static'&&sImg)renderSP();
});

function esc(s){return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;')}

function renderTxtList(){
  var L=$('txtL');
  L.innerHTML='';
  $('lTC').textContent=txts.length;

  txts.forEach(function(t,i){
    var d=document.createElement('div');
    d.className='txt-item';
    d.innerHTML=
      '<div class="ti-head"><span>Text #'+(i+1)+'</span><button class="ti-remove" data-id="'+t.id+'">âœ•</button></div>'+
      '<input type="text" value="'+esc(t.text)+'" data-id="'+t.id+'" data-f="text" placeholder="Type here..."/>'+
      '<div class="ti-row"><div><div class="ti-label">Font</div><select data-id="'+t.id+'" data-f="font">'+FONTS.map(function(f){return'<option value="'+f+'"'+(f===t.font?' selected':'')+'>'+f+'</option>'}).join('')+'</select></div><div><div class="ti-label">Size</div><input type="range" min="16" max="120" value="'+t.size+'" data-id="'+t.id+'" data-f="size"/></div></div>'+
      '<div class="ti-row3"><div><div class="ti-label">Fill</div><input type="color" value="'+t.color+'" data-id="'+t.id+'" data-f="color"/></div><div><div class="ti-label">Stroke</div><input type="color" value="'+t.sc+'" data-id="'+t.id+'" data-f="sc"/></div><div><div class="ti-label">Stroke W</div><input type="range" min="0" max="12" value="'+t.sw+'" data-id="'+t.id+'" data-f="sw"/></div></div>'+
      '<div class="ti-row3"><div class="ti-style-btns"><button data-id="'+t.id+'" data-f="bold" class="'+(t.bold?'active':'')+'"><b>B</b></button><button data-id="'+t.id+'" data-f="italic" class="'+(t.italic?'active':'')+'"><i>I</i></button></div><div><div class="ti-label">Rotation</div><input type="range" min="-180" max="180" value="'+t.rot+'" data-id="'+t.id+'" data-f="rot"/></div><div></div></div>'+
      '<div class="ti-pos"><div class="ti-label">Position</div><div><div class="ti-label" data-xl="'+t.id+'">X: '+t.x+'</div><input type="range" min="0" max="512" value="'+t.x+'" data-id="'+t.id+'" data-f="x"/></div><div><div class="ti-label" data-yl="'+t.id+'">Y: '+t.y+'</div><input type="range" min="0" max="512" value="'+t.y+'" data-id="'+t.id+'" data-f="y"/></div></div>';
    L.appendChild(d);
  });

  /* Bind remove */
  L.querySelectorAll('.ti-remove').forEach(function(b){
    b.addEventListener('click',function(){
      txts=txts.filter(function(t){return t.id!==parseInt(b.dataset.id)});
      renderTxtList();
      if(mode==='static'&&sImg)renderSP();
    });
  });

  /* Bind inputs */
  L.querySelectorAll('input[data-f],select[data-f]').forEach(function(el){
    el.addEventListener('input',function(){
      var it=txts.find(function(t){return t.id===parseInt(el.dataset.id)});
      if(!it)return;
      var f=el.dataset.f;
      if(f==='size'||f==='sw'||f==='x'||f==='y'||f==='rot') it[f]=parseInt(el.value);
      else it[f]=el.value;
      if(f==='x'){var lb=L.querySelector('[data-xl="'+el.dataset.id+'"]');if(lb)lb.textContent='X: '+el.value}
      if(f==='y'){var lb2=L.querySelector('[data-yl="'+el.dataset.id+'"]');if(lb2)lb2.textContent='Y: '+el.value}
      if(mode==='static'&&sImg)renderSP();
    });
  });

  /* Bind style buttons */
  L.querySelectorAll('.ti-style-btns button').forEach(function(b){
    b.addEventListener('click',function(){
      var it=txts.find(function(t){return t.id===parseInt(b.dataset.id)});
      if(!it)return;
      it[b.dataset.f]=!it[b.dataset.f];
      b.classList.toggle('active');
      if(mode==='static'&&sImg)renderSP();
    });
  });
}

function drawTexts(ctx){
  txts.forEach(function(t){
    if(!t.text)return;
    ctx.save();
    ctx.translate(t.x,t.y);
    if(t.rot)ctx.rotate(t.rot*Math.PI/180);
    ctx.font=(t.italic?'italic ':'')+(t.bold?'bold ':'')+t.size+"px '"+t.font+"',sans-serif";
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    if(t.sw>0){
      ctx.strokeStyle=t.sc;
      ctx.lineWidth=t.sw*2;
      ctx.lineJoin='round';
      ctx.miterLimit=2;
      ctx.strokeText(t.text,0,0);
    }
    ctx.fillStyle=t.color;
    ctx.fillText(t.text,0,0);
    ctx.restore();
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO-TRIM (crop transparent edges)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function cropBox(img){
  var mx=1024,iw=img.naturalWidth,ih=img.naturalHeight;
  var sc=Math.min(1,mx/Math.max(iw,ih));
  var aw=Math.max(1,Math.round(iw*sc)),ah=Math.max(1,Math.round(ih*sc));
  var c=document.createElement('canvas');c.width=aw;c.height=ah;
  var ctx=c.getContext('2d',{willReadFrequently:true});
  ctx.clearRect(0,0,aw,ah);
  ctx.drawImage(img,0,0,aw,ah);
  var d;
  try{d=ctx.getImageData(0,0,aw,ah).data}catch(e){return null}
  var x0=aw,y0=ah,x1=-1,y1=-1,ha=false;
  for(var y=0;y<ah;y++){
    for(var x=0;x<aw;x++){
      var a=d[(y*aw+x)*4+3];
      if(a<255)ha=true;
      if(a>8){if(x<x0)x0=x;if(y<y0)y0=y;if(x>x1)x1=x;if(y>y1)y1=y}
    }
  }
  if(!ha||x1<0)return null;
  var p=2;
  x0=clamp(x0-p,0,aw-1);y0=clamp(y0-p,0,ah-1);
  x1=clamp(x1+p,0,aw-1);y1=clamp(y1+p,0,ah-1);
  var inv=1/sc;
  return{
    sx:clamp(Math.round(x0*inv),0,iw-1),
    sy:clamp(Math.round(y0*inv),0,ih-1),
    sw:clamp(Math.round((x1-x0+1)*inv),1,iw),
    sh:clamp(Math.round((y1-y0+1)*inv),1,ih)
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD SINGLE FRAME â€” 512Ã—512 with REAL transparency
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildFrame(src,sz,addText){
  if(!sz)sz=512;
  if(addText===undefined)addText=true;

  var pad=parseInt(cPad.value);
  var ow=parseInt(cOW.value);
  var sb=parseInt(cSB.value);
  var oc=cOC.value;
  var shc=cSC.value;
  var bgm=cBg.value;
  var bgc=cBgC.value;

  var sw,sh;
  if(src instanceof HTMLCanvasElement){sw=src.width;sh=src.height}
  else{sw=src.naturalWidth||src.width;sh=src.naturalHeight||src.height}

  /* Image layer â€” fully transparent canvas */
  var il=document.createElement('canvas');il.width=sz;il.height=sz;
  var ic=il.getContext('2d');
  ic.clearRect(0,0,sz,sz);
  ic.imageSmoothingEnabled=true;
  ic.imageSmoothingQuality='high';
  var maxContent=Math.max(1,sz-2*pad);
  var scale=Math.min(maxContent/sw,maxContent/sh);
  var dw=Math.round(sw*scale),dh=Math.round(sh*scale);
  var dx=Math.round((sz-dw)/2),dy=Math.round((sz-dh)/2);
  ic.drawImage(src,0,0,sw,sh,dx,dy,dw,dh);

  /* Silhouette for outline */
  var sil=document.createElement('canvas');sil.width=sz;sil.height=sz;
  var sx=sil.getContext('2d');
  sx.drawImage(il,0,0);
  sx.globalCompositeOperation='source-in';
  sx.fillStyle=oc;
  sx.fillRect(0,0,sz,sz);

  /* Output canvas â€” TRANSPARENT by default */
  var out=document.createElement('canvas');out.width=sz;out.height=sz;
  var ctx=out.getContext('2d');
  ctx.clearRect(0,0,sz,sz);

  /* Only fill if user chose solid background */
  if(bgm==='solid'){
    ctx.fillStyle=bgc;
    ctx.fillRect(0,0,sz,sz);
  }
  /* NOTE: if bgm==='transparent', canvas stays fully transparent (alpha=0) */

  /* Shadow */
  if(sb>0){
    ctx.save();
    ctx.filter='blur('+sb+'px)';
    ctx.globalAlpha=0.3;
    var ss=document.createElement('canvas');ss.width=sz;ss.height=sz;
    var sc2=ss.getContext('2d');
    sc2.drawImage(il,0,0);
    sc2.globalCompositeOperation='source-in';
    sc2.fillStyle=shc;
    sc2.fillRect(0,0,sz,sz);
    ctx.drawImage(ss,4,7);
    ctx.restore();
  }

  /* Outline */
  if(ow>0){
    var steps=clamp(Math.round(ow*6),16,96);
    for(var i=0;i<steps;i++){
      var angle=(i/steps)*Math.PI*2;
      ctx.drawImage(sil,Math.cos(angle)*ow,Math.sin(angle)*ow);
    }
  }

  /* Image on top */
  ctx.drawImage(il,0,0);

  /* Text overlays */
  if(addText&&txts.length>0){
    drawTexts(ctx);
  }

  return out;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEBP EXPORT (browser native â€” preserves alpha)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function expWebp(canvas,maxBytes){
  var qualities=[];
  for(var q=0.95;q>=0.10;q-=0.04)qualities.push(parseFloat(q.toFixed(2)));
  var best=null,bestQ=null;
  for(var i=0;i<qualities.length;i++){
    var bl=await c2b(canvas,'image/webp',qualities[i]);
    if(!bl)return{blob:null};
    best=bl;bestQ=qualities[i];
    if(bl.size<=maxBytes)return{blob:bl,q:bestQ,ok:true};
  }
  return{blob:best,q:bestQ,ok:false};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATIC STICKER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var sFile=null,sImg=null,sWB=null,sSD=null;
var sOC=$('sOC');
var sOX=sOC.getContext('2d');

function sReset(){
  sOX.clearRect(0,0,512,512);
  sWB=null;sSD=null;
  $('sXM').textContent='â€”';
  $('stOut').textContent='â€”';
  $('stCo').textContent='â€”';
  $('plS').textContent='â€”';
  $('plT').textContent='â€”';
  setPl($('plS'),null);setPl($('plT'),null);
  $('sDl').disabled=true;$('sShr').disabled=true;
}

$('sBrw').addEventListener('click',function(){$('sFileIn').click()});
$('sDz').addEventListener('click',function(e){if(!e.target.closest('.btn'))$('sFileIn').click()});
['dragenter','dragover'].forEach(function(e){$('sDz').addEventListener(e,function(ev){ev.preventDefault();$('sDz').classList.add('dragover')})});
['dragleave','drop'].forEach(function(e){$('sDz').addEventListener(e,function(ev){ev.preventDefault();$('sDz').classList.remove('dragover')})});
$('sDz').addEventListener('drop',function(e){if(e.dataTransfer.files[0])sLoad(e.dataTransfer.files[0])});
$('sFileIn').addEventListener('change',function(){if($('sFileIn').files[0])sLoad($('sFileIn').files[0])});
$('sClr').addEventListener('click',function(){
  sFile=null;sImg=null;
  $('sOI').style.display='none';$('sOI').removeAttribute('src');
  $('sOP').style.display='';$('sOM').textContent='â€”';
  $('stIn').textContent='No file';
  $('sClr').disabled=true;$('sGen').disabled=true;
  $('sFileIn').value='';sReset();
});

function sLoad(f){
  if(!/^image\//i.test(f.type)){alert('Use PNG, JPG, GIF, or WEBP.');return}
  sFile=f;
  $('sClr').disabled=false;$('sGen').disabled=false;
  $('stIn').textContent=f.name+' ('+fmtB(f.size)+')';
  $('sOP').style.display='none';
  var u=URL.createObjectURL(f);
  $('sOI').style.display='block';
  $('sOI').src=u;
  var img=new Image();
  img.onload=function(){
    sImg=img;
    $('sOM').textContent=img.naturalWidth+'Ã—'+img.naturalHeight;
    renderSP();
    sReset();
  };
  img.onerror=function(){alert('Cannot read image.')};
  img.src=u;
}

function renderSP(){
  if(!sImg)return;
  var src=sImg;
  if(cTrim.checked){
    var c=cropBox(sImg);
    if(c){
      var t=document.createElement('canvas');
      t.width=c.sw;t.height=c.sh;
      t.getContext('2d').drawImage(sImg,c.sx,c.sy,c.sw,c.sh,0,0,c.sw,c.sh);
      src=t;
    }
  }
  var out=buildFrame(src,512,true);
  sOX.clearRect(0,0,512,512);
  sOX.drawImage(out,0,0);
}

$('sGen').addEventListener('click',async function(){
  if(!sImg)return;
  $('sGen').disabled=true;$('sSp').classList.add('on');
  $('sPrg').classList.add('on');$('sPF').style.width='20%';
  renderSP();

  /* Copy from preview canvas â€” preserving alpha */
  var c=document.createElement('canvas');c.width=512;c.height=512;
  var cx=c.getContext('2d');
  cx.clearRect(0,0,512,512);
  cx.drawImage(sOC,0,0);

  var mx=parseInt(cMK.value)*1024;
  $('sPF').style.width='50%';
  var r=await expWebp(c,mx);
  $('sPF').style.width='100%';

  if(r.blob){
    sWB=r.blob;
    var ok=r.blob.size<=mx;
    $('sXM').textContent='512Ã—512 Â· '+fmtB(r.blob.size)+' Â· q='+r.q;
    $('stOut').textContent='WEBP ('+fmtB(r.blob.size)+')';
    $('stCo').textContent=ok?'âœ“ Compliant':'âš  Over target';
    $('plS').textContent=fmtB(r.blob.size);$('plT').textContent='WEBP';
    setPl($('plT'),'ok');setPl($('plS'),ok?'ok':'warn');
    $('sDl').disabled=false;
    var bn=(sFile?sFile.name:'sticker').replace(/\.[^.]+$/,'');
    sSD={blob:sWB,type:'image/webp',fn:bn+'_sticker.webp'};
    $('sShr').disabled=false;
  }else{
    var pb=await c2b(c,'image/png',1);
    $('stOut').textContent='PNG fallback';$('plT').textContent='PNG';setPl($('plT'),'warn');
    if(pb){
      sWB=pb;
      var bn2=(sFile?sFile.name:'sticker').replace(/\.[^.]+$/,'');
      sSD={blob:pb,type:'image/png',fn:bn2+'_sticker.png'};
      $('sShr').disabled=false;$('sDl').disabled=false;
      $('plS').textContent=fmtB(pb.size);
    }
  }
  setTimeout(function(){$('sPrg').classList.remove('on')},400);
  $('sGen').disabled=false;$('sSp').classList.remove('on');
});

$('sDl').addEventListener('click',function(){
  if(sWB)dlBlob(sWB,(sFile?sFile.name:'sticker').replace(/\.[^.]+$/,'')+'_sticker.webp');
});
$('sShr').addEventListener('click',function(){share(sSD)});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GIF DECODER (pure JS)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function GifDecoder(buf){
  this.d=new Uint8Array(buf);this.p=0;this.frames=[];
}
GifDecoder.prototype.rb=function(){return this.d[this.p++]};
GifDecoder.prototype.r16=function(){var v=this.d[this.p]|(this.d[this.p+1]<<8);this.p+=2;return v};
GifDecoder.prototype.rn=function(n){var s=this.d.slice(this.p,this.p+n);this.p+=n;return s};
GifDecoder.prototype.skip=function(){while(true){var s=this.rb();if(!s)break;this.p+=s}};
GifDecoder.prototype.rsub=function(){
  var ch=[];while(true){var s=this.rb();if(!s)break;ch.push(this.rn(s))}
  var t=0;for(var i=0;i<ch.length;i++)t+=ch[i].length;
  var o=new Uint8Array(t);var off=0;
  for(var i=0;i<ch.length;i++){o.set(ch[i],off);off+=ch[i].length}
  return o;
};
GifDecoder.prototype.decode=function(){
  var sig=String.fromCharCode.apply(null,this.rn(6));
  if(sig.indexOf('GIF')!==0)throw new Error('Not GIF');
  this.w=this.r16();this.h=this.r16();
  var pk=this.rb();this.bgI=this.rb();this.rb();
  var gf=(pk>>7)&1,gs=1<<((pk&7)+1);
  this.gct=gf?this.rn(gs*3):null;
  var fc=document.createElement('canvas');fc.width=this.w;fc.height=this.h;
  var fx=fc.getContext('2d');
  var delay=100,disp=0,ti=-1;

  while(this.p<this.d.length){
    var b=this.rb();
    if(b===0x3B)break;
    if(b===0x21){
      var l=this.rb();
      if(l===0xF9){
        this.rb();var gp=this.rb();
        delay=this.r16()*10;if(delay<20)delay=100;
        ti=(gp&1)?this.rb():(this.rb(),-1);
        disp=(gp>>2)&7;this.rb();
      }else this.skip();
      continue;
    }
    if(b===0x2C){
      var left=this.r16(),top=this.r16(),w=this.r16(),h=this.r16();
      var ip=this.rb(),lf=(ip>>7)&1,ls=1<<((ip&7)+1);
      var ct=this.gct;if(lf)ct=this.rn(ls*3);
      var mcs=this.rb(),lzw=this.rsub();
      var px=this.lzwDec(mcs,lzw,w*h);
      var prev=null;if(disp===3)prev=fx.getImageData(0,0,this.w,this.h);
      var id=fx.getImageData(left,top,w,h);
      for(var i=0;i<px.length;i++){
        var ci=px[i];if(ci===ti)continue;
        id.data[i*4]=ct[ci*3];id.data[i*4+1]=ct[ci*3+1];
        id.data[i*4+2]=ct[ci*3+2];id.data[i*4+3]=255;
      }
      fx.putImageData(id,left,top);
      var fr=document.createElement('canvas');fr.width=this.w;fr.height=this.h;
      fr.getContext('2d').drawImage(fc,0,0);
      this.frames.push({canvas:fr,delay:delay});
      if(disp===2)fx.clearRect(left,top,w,h);
      else if(disp===3&&prev)fx.putImageData(prev,0,0);
      ti=-1;disp=0;
    }
  }
  return this.frames;
};
GifDecoder.prototype.lzwDec=function(mcs,data,pc){
  var cl=1<<mcs,eoi=cl+1;
  var cs=mcs+1,cm=(1<<cs)-1,nc=eoi+1;
  var MX=4096;
  var pf=new Int16Array(MX),sf=new Uint8Array(MX),ln=new Uint16Array(MX);
  function init(){for(var i=0;i<cl;i++){pf[i]=-1;sf[i]=i;ln[i]=1}nc=eoi+1;cs=mcs+1;cm=(1<<cs)-1}
  init();
  var out=new Uint8Array(pc);var op=0,bb=0,bc=0,dp=0;
  function rc(){while(bc<cs){if(dp>=data.length)return-1;bb|=data[dp++]<<bc;bc+=8}var c=bb&cm;bb>>=cs;bc-=cs;return c}
  function oc(code){var l=ln[code];var c=code;for(var i=l-1;i>=0;i--){out[op+i]=sf[c];c=pf[c]}op+=l}
  var prev=-1;
  while(op<pc){
    var code=rc();if(code===-1||code===eoi)break;
    if(code===cl){init();prev=-1;continue}
    if(prev===-1){oc(code);prev=code;continue}
    if(code<nc){
      oc(code);
      if(nc<MX){pf[nc]=prev;var c2=code;while(pf[c2]!==-1)c2=pf[c2];sf[nc]=sf[c2];ln[nc]=ln[prev]+1;nc++}
    }else{
      if(nc<MX){pf[nc]=prev;var c3=prev;while(pf[c3]!==-1)c3=pf[c3];sf[nc]=sf[c3];ln[nc]=ln[prev]+1;nc++}
      oc(code);
    }
    if(nc>cm&&cs<12){cs++;cm=(1<<cs)-1}
    prev=code;
  }
  return out;
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIDEO FRAME EXTRACTOR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function vidFrames(file,maxDur){
  return new Promise(function(res,rej){
    var v=document.createElement('video');
    v.muted=true;v.playsInline=true;v.preload='auto';
    var u=URL.createObjectURL(file);v.src=u;
    v.onloadedmetadata=async function(){
      var dur=Math.min(v.duration,maxDur);
      var fps=15,interval=1/fps;
      var frames=[];var t=0;
      function seek(t2){return new Promise(function(r){v.onseeked=function(){r()};v.currentTime=t2})}
      while(t<dur){
        await seek(t);
        var c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;
        c.getContext('2d').drawImage(v,0,0);
        frames.push({canvas:c,delay:Math.round(interval*1000)});
        t+=interval;
      }
      URL.revokeObjectURL(u);res(frames);
    };
    v.onerror=function(){URL.revokeObjectURL(u);rej(new Error('Video load failed'))};
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATED WEBP ENCODER â€” with ALPHA support
   
   Fixes:
   1. VP8X flags include alpha bit (0x10)
   2. ALPH chunks from frames are preserved
   3. VP8L chunks (lossless with alpha) preserved
   4. Proper RIFF padding on odd-sized chunks
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function AnimWebpEncoder(w,h,loop){
  this.w=w;this.h=h;this.loop=loop||0;this.fd=[];
}

AnimWebpEncoder.prototype.addFrame=async function(canvas,durMs,quality){
  var blob=await new Promise(function(r){canvas.toBlob(function(b){r(b)},'image/webp',quality/100)});
  if(!blob)throw new Error('WebP not supported');
  var buf=new Uint8Array(await blob.arrayBuffer());
  this.fd.push({raw:buf,dur:durMs});
};

AnimWebpEncoder.prototype._parseChunks=function(raw){
  if(raw.length<12)throw new Error('Too small');
  var chunks=[];var p=12;
  while(p+8<=raw.length){
    var cc=String.fromCharCode(raw[p],raw[p+1],raw[p+2],raw[p+3]);
    var sz=raw[p+4]|(raw[p+5]<<8)|(raw[p+6]<<16)|(raw[p+7]<<24);
    if(sz<0||p+8+sz>raw.length+1)break;
    chunks.push({f:cc,d:raw.slice(p+8,p+8+sz)});
    p+=8+sz+(sz&1);
  }
  return chunks;
};

AnimWebpEncoder.prototype.build=function(){
  var self=this;

  /* Extract image chunks from each frame */
  var fcs=this.fd.map(function(f){
    var chunks=self._parseChunks(f.raw);
    /* Keep ALPH + VP8 + VP8L â€” these carry the actual image+alpha data */
    var imgChunks=chunks.filter(function(c){
      return c.f==='VP8 '||c.f==='VP8L'||c.f==='ALPH';
    });
    if(!imgChunks.length)throw new Error('No VP8 data in frame');
    return{ch:imgChunks,dur:f.dur};
  });

  /* Detect alpha across all frames */
  var hasAlpha=false;
  for(var fi=0;fi<fcs.length;fi++){
    for(var ci=0;ci<fcs[fi].ch.length;ci++){
      if(fcs[fi].ch[ci].f==='ALPH'||fcs[fi].ch[ci].f==='VP8L'){hasAlpha=true;break}
    }
    if(hasAlpha)break;
  }

  /* Build ANMF chunks */
  var anmfBuffers=fcs.map(function(fc){
    var subPayload=0;
    for(var i=0;i<fc.ch.length;i++){
      subPayload+=8+fc.ch[i].d.length+(fc.ch[i].d.length&1);
    }
    var anmfPayload=16+subPayload;
    var anmfTotal=8+anmfPayload+(anmfPayload&1);
    var buf=new Uint8Array(anmfTotal);
    var dv=new DataView(buf.buffer);

    /* ANMF fourcc */
    buf[0]=0x41;buf[1]=0x4E;buf[2]=0x4D;buf[3]=0x46;
    dv.setUint32(4,anmfPayload,true);

    /* Offsets X=0 Y=0 */
    buf[8]=buf[9]=buf[10]=buf[11]=buf[12]=buf[13]=0;

    /* Width-1 (24-bit) */
    var w1=self.w-1;
    buf[14]=w1&0xFF;buf[15]=(w1>>8)&0xFF;buf[16]=(w1>>16)&0xFF;
    /* Height-1 (24-bit) */
    var h1=self.h-1;
    buf[17]=h1&0xFF;buf[18]=(h1>>8)&0xFF;buf[19]=(h1>>16)&0xFF;

    /* Duration (24-bit) */
    buf[20]=fc.dur&0xFF;buf[21]=(fc.dur>>8)&0xFF;buf[22]=(fc.dur>>16)&0xFF;

    /* Flags: dispose to background (bit 0=1), alpha blend off (bit 1=1) = 0x02 */
    buf[23]=0x02;

    /* Write sub-chunks */
    var off=24;
    for(var i=0;i<fc.ch.length;i++){
      var ch=fc.ch[i];
      buf[off]=ch.f.charCodeAt(0);buf[off+1]=ch.f.charCodeAt(1);
      buf[off+2]=ch.f.charCodeAt(2);buf[off+3]=ch.f.charCodeAt(3);
      dv.setUint32(off+4,ch.d.length,true);
      buf.set(ch.d,off+8);
      off+=8+ch.d.length+(ch.d.length&1);
    }
    return buf;
  });

  /* ANIM chunk */
  var animBuf=new Uint8Array(14);
  animBuf[0]=0x41;animBuf[1]=0x4E;animBuf[2]=0x49;animBuf[3]=0x4D;
  new DataView(animBuf.buffer).setUint32(4,6,true);
  new DataView(animBuf.buffer).setUint32(8,0,true); /* BG=transparent */
  new DataView(animBuf.buffer).setUint16(12,this.loop,true);

  /* VP8X chunk */
  var vp8x=new Uint8Array(18);
  vp8x[0]=0x56;vp8x[1]=0x50;vp8x[2]=0x38;vp8x[3]=0x58;
  new DataView(vp8x.buffer).setUint32(4,10,true);
  var flags=0x02; /* animation */
  if(hasAlpha)flags|=0x10; /* alpha */
  vp8x[8]=flags;
  vp8x[9]=vp8x[10]=vp8x[11]=0;
  var cw=this.w-1;
  vp8x[12]=cw&0xFF;vp8x[13]=(cw>>8)&0xFF;vp8x[14]=(cw>>16)&0xFF;
  var ch2=this.h-1;
  vp8x[15]=ch2&0xFF;vp8x[16]=(ch2>>8)&0xFF;vp8x[17]=(ch2>>16)&0xFF;

  /* Assemble RIFF */
  var totalPayload=vp8x.length+animBuf.length;
  for(var i=0;i<anmfBuffers.length;i++)totalPayload+=anmfBuffers[i].length;

  var riff=new Uint8Array(12+totalPayload);
  var rv=new DataView(riff.buffer);
  riff[0]=0x52;riff[1]=0x49;riff[2]=0x46;riff[3]=0x46;
  rv.setUint32(4,4+totalPayload,true);
  riff[8]=0x57;riff[9]=0x45;riff[10]=0x42;riff[11]=0x50;

  var o=12;
  riff.set(vp8x,o);o+=vp8x.length;
  riff.set(animBuf,o);o+=animBuf.length;
  for(var i=0;i<anmfBuffers.length;i++){riff.set(anmfBuffers[i],o);o+=anmfBuffers[i].length}

  return new Blob([riff],{type:'image/webp'});
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATED STICKER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var aFile=null,aIsGif=false,aWB=null,aSD=null;
var aOC=$('aOC');
var aOX=aOC.getContext('2d');

function aReset(){
  aOX.clearRect(0,0,512,512);aWB=null;aSD=null;
  $('aXM').textContent='â€”';$('stOut').textContent='â€”';$('stCo').textContent='â€”';
  $('plS').textContent='â€”';$('plT').textContent='â€”';
  setPl($('plS'),null);setPl($('plT'),null);
  $('aDl').disabled=true;$('aShr').disabled=true;
  $('aXI').style.display='none';aOC.style.display='';
}

$('aBrw').addEventListener('click',function(){$('aFileIn').click()});
$('aDz').addEventListener('click',function(e){if(!e.target.closest('.btn'))$('aFileIn').click()});
['dragenter','dragover'].forEach(function(e){$('aDz').addEventListener(e,function(ev){ev.preventDefault();$('aDz').classList.add('dragover')})});
['dragleave','drop'].forEach(function(e){$('aDz').addEventListener(e,function(ev){ev.preventDefault();$('aDz').classList.remove('dragover')})});
$('aDz').addEventListener('drop',function(e){if(e.dataTransfer.files[0])aLoad(e.dataTransfer.files[0])});
$('aFileIn').addEventListener('change',function(){if($('aFileIn').files[0])aLoad($('aFileIn').files[0])});
$('aClr').addEventListener('click',function(){
  aFile=null;
  $('aOI').style.display='none';$('aOI').removeAttribute('src');
  $('aOV').style.display='none';$('aOV').removeAttribute('src');
  $('aOP').style.display='';$('aOM').textContent='â€”';
  $('stIn').textContent='No file';
  $('aClr').disabled=true;$('aGen').disabled=true;
  $('aFileIn').value='';aReset();
});

function aLoad(f){
  var ig=f.type==='image/gif'||/\.gif$/i.test(f.name);
  var iv=/^video\/(mp4|webm)$/.test(f.type)||/\.(mp4|webm)$/i.test(f.name);
  if(!ig&&!iv){alert('Use GIF, MP4, or WEBM.');return}
  aFile=f;aIsGif=ig;
  $('aClr').disabled=false;$('aGen').disabled=false;
  $('stIn').textContent=f.name+' ('+fmtB(f.size)+')';
  $('aOP').style.display='none';
  var u=URL.createObjectURL(f);
  if(ig){
    $('aOI').src=u;$('aOI').style.display='block';$('aOV').style.display='none';
    $('aOM').textContent='GIF';
  }else{
    $('aOV').src=u;$('aOV').style.display='block';$('aOI').style.display='none';
    $('aOV').play();
    $('aOV').onloadedmetadata=function(){
      $('aOM').textContent=$('aOV').videoWidth+'Ã—'+$('aOV').videoHeight+' Â· '+$('aOV').duration.toFixed(1)+'s';
    };
  }
  aReset();
}

$('aGen').addEventListener('click',async function(){
  if(!aFile)return;
  $('aGen').disabled=true;$('aSp').classList.add('on');
  $('aPrg').classList.add('on');$('aPF').style.width='5%';

  try{
    var maxDur=parseInt(cDur.value);
    var speedMult=parseInt(cSpd.value)/100;
    var quality=parseInt(cQ.value);
    var maxBytes=parseInt(cMK.value)*1024;

    $('stOut').textContent='Extracting framesâ€¦';$('aPF').style.width='10%';

    var rawFrames;
    if(aIsGif){
      var buf=await aFile.arrayBuffer();
      var dec=new GifDecoder(buf);
      rawFrames=dec.decode();
      if(!rawFrames.length)throw new Error('No frames');
    }else{
      rawFrames=await vidFrames(aFile,maxDur);
      if(!rawFrames.length)throw new Error('No frames');
    }

    $('aPF').style.width='25%';
    $('stOut').textContent=rawFrames.length+' frames extracted';

    /* Apply speed + trim */
    var frames=rawFrames.map(function(f){
      return{canvas:f.canvas,delay:Math.max(20,Math.round(f.delay/speedMult))};
    });

    var cum=0,maxMs=maxDur*1000,trimmed=[];
    for(var i=0;i<frames.length;i++){
      if(cum>=maxMs)break;
      trimmed.push(frames[i]);
      cum+=frames[i].delay;
    }
    frames=trimmed;

    /* Downsample if too many */
    if(frames.length>150){
      var step=frames.length/150;var sampled=[];
      for(var i=0;i<150;i++){
        sampled.push(frames[Math.min(Math.round(i*step),frames.length-1)]);
      }
      frames=sampled;
    }

    $('stOut').textContent='Processing '+frames.length+' framesâ€¦';
    $('aPF').style.width='30%';

    var processed=[];
    for(var i=0;i<frames.length;i++){
      var outFrame=buildFrame(frames[i].canvas,512,true);
      processed.push({canvas:outFrame,delay:frames[i].delay});
      if(i%5===0){
        $('aPF').style.width=(30+(i/frames.length)*35)+'%';
        aOX.clearRect(0,0,512,512);
        aOX.drawImage(outFrame,0,0);
        await new Promise(function(r){setTimeout(r,0)});
      }
    }

    $('aPF').style.width='65%';
    $('stOut').textContent='Encoding animated WebPâ€¦';

    var enc=new AnimWebpEncoder(512,512,0);
    for(var i=0;i<processed.length;i++){
      await enc.addFrame(processed[i].canvas,processed[i].delay,quality);
      if(i%3===0){
        $('aPF').style.width=(65+(i/processed.length)*25)+'%';
        await new Promise(function(r){setTimeout(r,0)});
      }
    }

    $('aPF').style.width='92%';
    var blob=enc.build();

    /* Auto-optimize if too large */
    if(blob.size>maxBytes){
      $('stOut').textContent='Optimizing sizeâ€¦';
      for(var q=quality-15;q>=15;q-=15){
        var e2=new AnimWebpEncoder(512,512,0);
        for(var j=0;j<processed.length;j++)await e2.addFrame(processed[j].canvas,processed[j].delay,q);
        blob=e2.build();
        if(blob.size<=maxBytes)break;
      }
      if(blob.size>maxBytes&&processed.length>8){
        var half=[];
        for(var j=0;j<processed.length;j+=2){
          half.push({canvas:processed[j].canvas,delay:processed[j].delay*2});
        }
        var e3=new AnimWebpEncoder(512,512,0);
        for(var j=0;j<half.length;j++)await e3.addFrame(half[j].canvas,half[j].delay,15);
        blob=e3.build();
      }
    }

    $('aPF').style.width='100%';
    aWB=blob;
    var ok=blob.size<=maxBytes;
    var totalDur=(frames.reduce(function(s,f){return s+f.delay},0)/1000).toFixed(1);

    $('aXM').textContent='512Ã—512 Â· '+frames.length+'f Â· '+totalDur+'s Â· '+fmtB(blob.size);
    $('stOut').textContent='Animated WEBP ('+fmtB(blob.size)+')';
    $('stCo').textContent=ok?'âœ“ Compliant':'âš  Over target';
    $('plS').textContent=fmtB(blob.size);$('plT').textContent='AWEBP';
    setPl($('plT'),'ok');setPl($('plS'),ok?'ok':'warn');

    var pu=URL.createObjectURL(blob);
    $('aXI').src=pu;$('aXI').style.display='block';
    aOC.style.display='none';

    var bn=(aFile?aFile.name:'sticker').replace(/\.[^.]+$/,'');
    aSD={blob:blob,type:'image/webp',fn:bn+'_animated.webp'};
    $('aDl').disabled=false;$('aShr').disabled=false;

  }catch(err){
    console.error(err);
    $('stOut').textContent='Error: '+err.message;
    $('stCo').textContent='âœ— Failed';
    alert('Error: '+err.message);
  }

  setTimeout(function(){$('aPrg').classList.remove('on')},400);
  $('aGen').disabled=false;$('aSp').classList.remove('on');
});

$('aDl').addEventListener('click',function(){
  if(aWB)dlBlob(aWB,(aFile?aFile.name:'sticker').replace(/\.[^.]+$/,'')+'_animated.webp');
});
$('aShr').addEventListener('click',function(){share(aSD)});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED: Download + Share
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dlBlob(blob,fn){
  var u=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=u;a.download=fn;
  document.body.appendChild(a);a.click();a.remove();
  setTimeout(function(){URL.revokeObjectURL(u)},2000);
}

async function share(sd){
  if(!sd||!sd.blob){alert('Generate the sticker first.');return}
  var file=new File([sd.blob],sd.fn,{type:sd.type});

  try{
    if(navigator.canShare&&navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:'WhatsApp Sticker',text:'Send as sticker!'});
      return;
    }
  }catch(e){
    if(String(e).toLowerCase().indexOf('abort')>=0)return;
    console.warn(e);
  }

  dlBlob(sd.blob,sd.fn);
  var mob=/Android|iPhone|iPad/i.test(navigator.userAgent);
  if(mob){
    window.location.href='whatsapp://';
    setTimeout(function(){alert('File downloaded! Open WhatsApp â†’ any chat â†’ ğŸ“ attach â†’ select file â†’ long-press sent image â†’ "Add to stickers"')},1200);
  }else{
    alert('File downloaded!\n\n1. Open WhatsApp\n2. Open any chat\n3. Attach the .webp file\n4. Long-press the sent sticker\n5. Choose "Add to stickers"');
  }
}

})();
</script>
</body>
</html>
